<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoxMonitor | Мониторинг русских игровых боксов</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4FC3F7;
            --primary-dark: #0288D1;
            --primary-darker: #01579B;
            --secondary: #1E293B;
            --dark: #0F172A;
            --darker: #020617;
            --accent: #00BCD4;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --gradient: linear-gradient(135deg, #4FC3F7 0%, #0288D1 50%, #01579B 100%);
            --bg-gradient: linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #0F172A 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            color: #E2E8F0;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(79, 195, 247, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(2, 136, 209, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(1, 87, 155, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
        }
        
        .logo {
            font-size: 3.5rem;
            margin: 0;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 30px rgba(79, 195, 247, 0.5);
            position: relative;
            display: inline-block;
            font-weight: 800;
            letter-spacing: 2px;
        }
        
        .logo::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 4px;
            background: var(--gradient);
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
        }
        
        .tagline {
            color: #94A3B8;
            font-size: 1.2rem;
            margin-top: 15px;
            font-weight: 300;
            letter-spacing: 1px;
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(79, 195, 247, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
            border: 1px solid rgba(79, 195, 247, 0.1);
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #94A3B8;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            gap: 15px;
        }
        
        .search-box {
            flex: 1;
            max-width: 400px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 20px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(79, 195, 247, 0.3);
            border-radius: 10px;
            color: #E2E8F0;
            font-size: 1rem;
            backdrop-filter: blur(10px);
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
        }
        
        .filter-btn {
            padding: 10px 20px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(79, 195, 247, 0.3);
            border-radius: 8px;
            color: #E2E8F0;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        
        .filter-btn.active {
            background: var(--gradient);
            color: white;
            border-color: var(--primary);
        }
        
        .filter-btn:hover {
            border-color: var(--primary);
        }
        
        .sort-buttons {
            display: flex;
            gap: 10px;
        }
        
        .sort-btn {
            padding: 10px 20px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(79, 195, 247, 0.3);
            border-radius: 8px;
            color: #E2E8F0;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        
        .sort-btn.active {
            background: var(--gradient);
            color: white;
            border-color: var(--primary);
        }
        
        .sort-btn:hover {
            border-color: var(--primary);
        }
        
        .boxes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .box-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(15px);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(79, 195, 247, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .box-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient);
        }
        
        .box-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            border-color: rgba(79, 195, 247, 0.4);
        }
        
        .box-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .box-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.8rem;
            background: var(--gradient);
            box-shadow: 0 4px 15px rgba(79, 195, 247, 0.3);
        }
        
        .box-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .box-ip {
            color: #94A3B8;
            font-size: 0.9rem;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .box-ip:hover {
            color: var(--primary);
        }
        
        .box-status {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 5px;
        }
        
        .status-online {
            background: rgba(16, 185, 129, 0.2);
            color: #10B981;
            border: 1px solid rgba(16, 185, 129, 0.4);
        }
        
        .status-offline {
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }
        
        .status-afk {
            background: rgba(245, 158, 11, 0.2);
            color: #F59E0B;
            border: 1px solid rgba(245, 158, 11, 0.4);
        }
        
        .box-stats {
            margin-top: 20px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-name {
            color: #94A3B8;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-value-box {
            font-weight: 600;
            color: #E2E8F0;
        }
        
        .online-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .online {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }
        
        .offline {
            background: var(--danger);
            box-shadow: 0 0 8px var(--danger);
        }
        
        .afk {
            background: var(--warning);
            box-shadow: 0 0 8px var(--warning);
        }
        
        .last-updated {
            text-align: center;
            margin-top: 30px;
            color: #94A3B8;
            font-size: 0.9rem;
        }
        
        .refresh-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--gradient);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(2, 136, 209, 0.4);
        }
        
        .refresh-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(2, 136, 209, 0.6);
        }
        
        .refresh-btn:active {
            transform: translateY(-1px);
        }
        
        .refresh-btn.loading i {
            animation: spin 1s linear infinite;
        }
        
        .floating-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .floating-element {
            position: absolute;
            background: var(--gradient);
            border-radius: 50%;
            opacity: 0.1;
            animation: float 8s ease-in-out infinite;
        }
        
        .floating-element:nth-child(1) {
            width: 100px;
            height: 100px;
            top: 10%;
            left: 5%;
            animation-delay: 0s;
        }
        
        .floating-element:nth-child(2) {
            width: 60px;
            height: 60px;
            top: 60%;
            right: 10%;
            animation-delay: 2s;
        }
        
        .floating-element:nth-child(3) {
            width: 80px;
            height: 80px;
            bottom: 20%;
            left: 15%;
            animation-delay: 4s;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            background: var(--gradient);
            color: white;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1000;
            font-weight: 600;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .box-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .player-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .player-item {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .player-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--gradient);
        }
        
        @media (max-width: 768px) {
            .boxes-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .logo {
                font-size: 2.5rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .search-box {
                max-width: 100%;
            }
        }
        
        .motd {
            background: rgba(15, 23, 42, 0.6);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: 'Minecraft', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            max-height: 80px;
            overflow-y: auto;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--gradient);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .loading-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #94A3B8;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(79, 195, 247, 0.3);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        .error-message {
            color: #EF4444;
            text-align: center;
            padding: 20px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .demo-warning {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.4);
            color: #F59E0B;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="floating-elements">
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
    </div>
    
    <div class="container">
        <header>
            <h1 class="logo">BoxMonitor</h1>
            <p class="tagline">Мониторинг русских игровых боксов в реальном времени</p>
        </header>
        
        <div id="demoWarning" class="demo-warning" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Внимание:</strong> Некоторые сервера могут быть недоступны через API. Используются демо-данные для реалистичного отображения.
        </div>
        
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="total-boxes">21</div>
                <div class="stat-label">Всего боксов</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="online-boxes">0</div>
                <div class="stat-label">Онлайн</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-players">0</div>
                <div class="stat-label">Игроков онлайн</div>
            </div>
        </div>
        
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Поиск по названию бокса...">
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">Все</button>
                <button class="filter-btn" data-filter="online">Онлайн</button>
                <button class="filter-btn" data-filter="offline">Оффлайн</button>
            </div>
            
            <div class="sort-buttons">
                <button class="sort-btn active" data-sort="default">По умолчанию</button>
                <button class="sort-btn" data-sort="online">По онлайну</button>
            </div>
            
            <button class="refresh-btn" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> Обновить
            </button>
        </div>
        
        <div class="boxes-grid" id="boxes-container">
            <!-- Боксы будут добавлены через JavaScript -->
        </div>
        
        <div class="last-updated" id="lastUpdated">
            Последнее обновление: загружается...
        </div>
    </div>
    
    <div class="notification" id="notification">
        Уведомление
    </div>
    
    <script>
        // Ждем полной загрузки DOM
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM загружен, запускаем приложение...');
            
            // Получаем элементы после загрузки DOM
            const boxesContainer = document.getElementById('boxes-container');
            const refreshBtn = document.getElementById('refreshBtn');
            const lastUpdated = document.getElementById('lastUpdated');
            const searchInput = document.getElementById('searchInput');
            const filterButtons = document.querySelectorAll('.filter-btn');
            const sortButtons = document.querySelectorAll('.sort-btn');
            const notification = document.getElementById('notification');
            const demoWarning = document.getElementById('demoWarning');
            
            const totalBoxes = document.getElementById('total-boxes');
            const onlineBoxes = document.getElementById('online-boxes');
            const totalPlayers = document.getElementById('total-players');
            
            // Проверяем что все элементы найдены
            if (!boxesContainer) {
                console.error('boxes-container не найден!');
                return;
            }
            
            console.log('Все элементы DOM найдены успешно');

            // Русские Minecraft сервера
            const boxesData = [
                { 
                    name: "SpinBox", 
                    host: "play.spinbox.fun",
                    description: "Популярный русский бокс с мини-играми"
                },
                { 
                    name: "MoonBox", 
                    host: "play.moonbox.pw",
                    description: "Лунный бокс с уникальными режимами"
                },
                { 
                    name: "SureBox", 
                    host: "play.surebox.pro",
                    description: "Надежный бокс с стабильным онлайн"
                },
                { 
                    name: "Season Box", 
                    host: "mc.season-box.ru",
                    description: "Сезонный бокс с регулярными обновлениями"
                },
                { 
                    name: "SoulBox", 
                    host: "play.soulbox.pw",
                    description: "Бокс с атмосферными режимами"
                },
                { 
                    name: "HorizonBox", 
                    host: "horizonbox.fun",
                    description: "Бокс с расширенными горизонтами"
                },
                { 
                    name: "GrandBox", 
                    host: "mc.grandbox.fun",
                    description: "Грандиозный бокс с масштабными ивентами"
                },
                { 
                    name: "InfernoBox", 
                    host: "infernobox.fun",
                    description: "Огненный бокс с интенсивными баталиями"
                },
                { 
                    name: "GloryTime", 
                    host: "mc.glorytime.fun",
                    description: "Бокс славного времени с эксклюзивными режимами"
                },
                { 
                    name: "UltimateBox", 
                    host: "play.ultimatebox.pro",
                    description: "Ультимативный бокс с премиум контентом"
                },
                { 
                    name: "RichWorld", 
                    host: "Play.RichWorld.me",
                    description: "Богатый мир с уникальной экономикой"
                },
                { 
                    name: "ReservBox", 
                    host: "play.reserv.fun",
                    description: "Резервный бокс с эксклюзивными ивентами"
                },
                { 
                    name: "SeroBox", 
                    host: "play.serobox.fun",
                    description: "Серый бокс с классическими режимами"
                },
                { 
                    name: "IceBox", 
                    host: "mc.iceboxs.fun",
                    description: "Ледяной бокс с холодными баталиями"
                },
                { 
                    name: "BoxPvP", 
                    host: "play.boxpvpava.fun",
                    description: "Бокс для любителей PvP сражений"
                },
                { 
                    name: "PowerBox", 
                    host: "play.powerbox.fun",
                    description: "Мощный бокс с усиленными возможностями"
                },
                { 
                    name: "NetherBox", 
                    host: "mc.nether.day",
                    description: "Адский бокс с тематикой Незера"
                },
                { 
                    name: "HollBox", 
                    host: "mc.hollbox.xyz",
                    description: "Полый бокс с уникальной архитектурой"
                },
                { 
                    name: "StarBox", 
                    host: "mc.starbox.lol",
                    description: "Звездный бокс с космическими приключениями"
                },
                { 
                    name: "JustBox", 
                    host: "play.just-box.fun",
                    description: "Простой и удобный бокс для всех"
                },
                { 
                    name: "InfinityBox", 
                    host: "InfinityBox.lol",
                    description: "Бесконечный бокс с безграничными возможностями"
                }
            ];
            
            let currentFilter = 'all';
            let currentSearch = '';
            let currentSort = 'default';
            let boxesStatus = {};
            let serverHistory = {};
            let apiErrors = 0;
            
            // Инициализация данных
            function initializeData() {
                boxesData.forEach(box => {
                    serverHistory[box.host] = {
                        lastOnline: null,
                        offlineCount: 0,
                        lastStatus: null,
                        consecutiveFails: 0,
                        lastFailTime: null
                    };
                });
            }
            
            // Показать уведомление
            function showNotification(message, duration = 3000) {
                if (!notification) {
                    console.log('Notification:', message);
                    return;
                }
                notification.textContent = message;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, duration);
            }
            
            // Обновить время
            function updateTime() {
                if (!lastUpdated) return;
                const now = new Date();
                const timeString = now.toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                lastUpdated.textContent = `Последнее обновление: ${timeString}`;
            }
            
            // Обновить статистику
            function updateStats() {
                const boxes = Object.values(boxesStatus);
                const onlineCount = boxes.filter(box => box.status === 'online').length;
                const totalPlayersCount = boxes.reduce((sum, box) => sum + (box.players?.online || 0), 0);
                
                if (totalBoxes) totalBoxes.textContent = boxes.length;
                if (onlineBoxes) onlineBoxes.textContent = onlineCount;
                if (totalPlayers) totalPlayers.textContent = totalPlayersCount.toLocaleString();
            }
            
            // Проверить статус AFK
            function checkAfkStatus(host, currentStatus) {
                const history = serverHistory[host];
                const now = Date.now();
                
                if (currentStatus.online) {
                    // Сервер онлайн - сбрасываем счетчики
                    history.lastOnline = now;
                    history.offlineCount = 0;
                    history.consecutiveFails = 0;
                    history.lastStatus = 'online';
                    return 'online';
                } else {
                    // Сервер офлайн
                    history.consecutiveFails++;
                    history.lastFailTime = now;
                    
                    // Проверяем условия для перехода в офлайн
                    const timeSinceLastOnline = history.lastOnline ? (now - history.lastOnline) : Infinity;
                    const timeSinceFirstFail = history.lastFailTime ? (now - history.lastFailTime) : 0;
                    
                    // Переходим в офлайн только если:
                    // 1. Прошло больше 3 минут с последнего успешного пинга ИЛИ
                    // 2. Было 5+ последовательных неудачных пингов
                    if ((timeSinceLastOnline > 3 * 60 * 1000) || 
                        (history.consecutiveFails >= 5)) {
                        history.lastStatus = 'offline';
                        return 'offline';
                    } else {
                        // Временные проблемы - статус AFK
                        history.lastStatus = 'afk';
                        return 'afk';
                    }
                }
            }
            
            // Получить статус сервера через API
            async function fetchServerStatus(box) {
                try {
                    const response = await fetch(`https://api.mcstatus.io/v2/status/java/${box.host}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        const status = checkAfkStatus(box.host, data);
                        return {
                            status: status,
                            online: data.online,
                            host: box.host,
                            ip: data.host || box.host,
                            players: data.players,
                            version: data.version?.name_clean,
                            motd: {
                                clean: [data.motd?.clean]
                            },
                            software: data.software,
                            ...box
                        };
                    }
                } catch (error) {
                    console.log(`mcstatus.io недоступен для ${box.host}:`, error);
                }
                
                try {
                    const response = await fetch(`https://api.mcsrvstat.us/3/${box.host}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        const status = checkAfkStatus(box.host, data);
                        return {
                            status: status,
                            online: data.online,
                            host: box.host,
                            ip: data.ip || box.host,
                            players: data.players,
                            version: data.version,
                            motd: data.motd,
                            software: data.software,
                            ...box
                        };
                    }
                } catch (error) {
                    console.log(`mcsrvstat.us недоступен для ${box.host}:`, error);
                }
                
                console.log(`Используем демо-данные для ${box.host}`);
                apiErrors++;
                return generateDemoData(box);
            }
            
            // Генерация реалистичных демо-данных
            function generateDemoData(box) {
                const now = new Date();
                const hour = now.getHours();
                let onlineMultiplier = 1;
                
                if (hour >= 0 && hour < 7) onlineMultiplier = 0.3;
                else if (hour >= 7 && hour < 12) onlineMultiplier = 0.6;
                else if (hour >= 12 && hour < 18) onlineMultiplier = 0.8;
                else onlineMultiplier = 1.1;
                
                const isOnline = Math.random() > 0.3;
                
                if (isOnline) {
                    const baseOnline = 500 * onlineMultiplier;
                    const onlinePlayers = Math.floor(Math.random() * baseOnline * 0.4) + baseOnline * 0.6;
                    const maxPlayers = Math.floor(onlinePlayers * 1.3) + 20;
                    
                    const status = checkAfkStatus(box.host, { online: true });
                    
                    return {
                        status: status,
                        online: true,
                        host: box.host,
                        ip: box.host,
                        players: {
                            online: Math.floor(onlinePlayers),
                            max: maxPlayers
                        },
                        version: "1.16.5 - 1.20.1",
                        motd: {
                            clean: [box.description]
                        },
                        software: "Paper/Bukkit",
                        ...box
                    };
                } else {
                    const status = checkAfkStatus(box.host, { online: false });
                    
                    return {
                        status: status,
                        online: false,
                        host: box.host,
                        ip: box.host,
                        ...box
                    };
                }
            }
            
            // Получить статус всех серверов
            async function fetchAllStatuses() {
                console.log('Начинаем обновление данных...');
                
                if (refreshBtn) refreshBtn.classList.add('loading');
                showNotification('Обновление данных...', 2000);
                
                renderLoadingCards();
                
                apiErrors = 0;
                
                try {
                    const promises = boxesData.map(box => fetchServerStatus(box));
                    const results = await Promise.allSettled(promises);
                    
                    results.forEach((result, index) => {
                        if (result.status === 'fulfilled') {
                            boxesStatus[boxesData[index].host] = result.value;
                        } else {
                            boxesStatus[boxesData[index].host] = generateDemoData(boxesData[index]);
                            apiErrors++;
                        }
                    });
                    
                } catch (error) {
                    console.error('Ошибка при обновлении данных:', error);
                    boxesData.forEach(box => {
                        boxesStatus[box.host] = generateDemoData(box);
                    });
                    apiErrors = boxesData.length;
                }
                
                if (refreshBtn) refreshBtn.classList.remove('loading');
                updateStats();
                renderBoxes();
                updateTime();
                
                if (apiErrors > 0) {
                    showNotification(`Обновлено! (${boxesData.length - apiErrors} реальных, ${apiErrors} демо)`);
                    if (demoWarning) demoWarning.style.display = 'block';
                } else {
                    showNotification('Все данные успешно обновлены!');
                    if (demoWarning) demoWarning.style.display = 'none';
                }
                
                console.log('Обновление данных завершено');
            }
            
            // Показать карточки загрузки
            function renderLoadingCards() {
                console.log('Показываем карточки загрузки...');
                if (!boxesContainer) {
                    console.error('boxesContainer не доступен для renderLoadingCards');
                    return;
                }
                
                boxesContainer.innerHTML = '';
                
                boxesData.forEach(box => {
                    const loadingCard = document.createElement('div');
                    loadingCard.className = 'box-card';
                    loadingCard.innerHTML = `
                        <div class="loading-card">
                            <div class="loading-spinner"></div>
                            <div>Загрузка ${box.name}...</div>
                        </div>
                    `;
                    boxesContainer.appendChild(loadingCard);
                });
            }
            
            // Сортировка боксов
            function sortBoxes(boxes) {
                switch (currentSort) {
                    case 'online':
                        return boxes.sort((a, b) => {
                            const aOnline = a.players?.online || 0;
                            const bOnline = b.players?.online || 0;
                            return bOnline - aOnline;
                        });
                    case 'default':
                    default:
                        return boxes;
                }
            }
            
            // Отрисовать боксы
            function renderBoxes() {
                console.log('Отрисовываем боксы...');
                if (!boxesContainer) {
                    console.error('boxesContainer не доступен для renderBoxes');
                    return;
                }
                
                boxesContainer.innerHTML = '';
                
                if (apiErrors > 0) {
                    const warning = document.createElement('div');
                    warning.className = 'demo-warning';
                    warning.style.gridColumn = '1 / -1';
                    warning.innerHTML = `
                        <i class="fas fa-info-circle"></i>
                        <strong>Информация:</strong> ${apiErrors} из ${boxesData.length} серверов используют демо-данные (API недоступно).
                    `;
                    boxesContainer.appendChild(warning);
                }
                
                let filteredBoxes = Object.values(boxesStatus).filter(box => {
                    const matchesSearch = box.name.toLowerCase().includes(currentSearch.toLowerCase());
                    const matchesFilter = currentFilter === 'all' || 
                                         (currentFilter === 'online' && box.status === 'online') ||
                                         (currentFilter === 'offline' && box.status !== 'online');
                    
                    return matchesSearch && matchesFilter;
                });
                
                filteredBoxes = sortBoxes(filteredBoxes);
                
                if (filteredBoxes.length === 0) {
                    boxesContainer.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #94A3B8;">
                            <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <h3>Боксы не найдены</h3>
                            <p>Попробуйте изменить параметры поиска или фильтра</p>
                        </div>
                    `;
                    return;
                }
                
                filteredBoxes.forEach(box => {
                    const boxCard = document.createElement('div');
                    boxCard.className = 'box-card';
                    
                    let statusClass, statusText, indicatorClass;
                    
                    switch (box.status) {
                        case 'online':
                            statusClass = 'status-online';
                            statusText = 'Онлайн';
                            indicatorClass = 'online';
                            break;
                        case 'afk':
                            statusClass = 'status-afk';
                            statusText = 'AFK';
                            indicatorClass = 'afk';
                            break;
                        default:
                            statusClass = 'status-offline';
                            statusText = 'Оффлайн';
                            indicatorClass = 'offline';
                    }
                    
                    const motd = box.motd ? 
                        (Array.isArray(box.motd.clean) ? box.motd.clean.join(' ') : box.motd.clean) : 
                        box.description;
                    
                    const players = box.players ? `
                        <div class="stat-row">
                            <span class="stat-name">
                                <i class="fas fa-users"></i> Игроки онлайн:
                            </span>
                            <span class="stat-value-box">${box.players.online}/${box.players.max}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min((box.players.online / box.players.max) * 100, 100)}%"></div>
                        </div>
                    ` : `
                        <div class="stat-row">
                            <span class="stat-name">
                                <i class="fas fa-users"></i> Игроки онлайн:
                            </span>
                            <span class="stat-value-box">0/0</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                    `;
                    
                    const version = box.version ? `
                        <div class="stat-row">
                            <span class="stat-name">
                                <i class="fas fa-code-branch"></i> Версия:
                            </span>
                            <span class="stat-value-box">${box.version}</span>
                        </div>
                    ` : '';
                    
                    const software = box.software ? `
                        <div class="stat-row">
                            <span class="stat-name">
                                <i class="fas fa-server"></i> Софт:
                            </span>
                            <span class="stat-value-box">${box.software}</span>
                        </div>
                    ` : '';
                    
                    boxCard.innerHTML = `
                        <div class="box-header">
                            <div class="box-icon">
                                <i class="fas fa-cube"></i>
                            </div>
                            <div style="flex: 1;">
                                <div class="box-name">${box.name}</div>
                                <div class="box-ip" onclick="copyToClipboard('${box.host}')">
                                    <i class="fas fa-copy"></i> ${box.host}
                                </div>
                                <span class="box-status ${statusClass}">
                                    <span class="online-indicator ${indicatorClass}"></span>
                                    ${statusText}
                                </span>
                            </div>
                        </div>
                        <div class="box-stats">
                            ${players}
                            ${version}
                            ${software}
                        </div>
                        <div class="box-details">
                            <div class="stat-name">
                                <i class="fas fa-info-circle"></i> Описание:
                            </div>
                            <div class="motd">${motd}</div>
                        </div>
                    `;
                    
                    boxesContainer.appendChild(boxCard);
                });
                
                console.log(`Отрисовано ${filteredBoxes.length} боксов`);
            }
            
            // Копировать IP в буфер обмена
            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification(`IP ${text} скопирован в буфер обмена!`);
                });
            }
            
            // Инициализация
            function init() {
                console.log('Инициализация приложения...');
                
                initializeData();
                
                // Сразу загружаем данные
                setTimeout(() => {
                    fetchAllStatuses();
                }, 100);
                
                // Автообновление каждые 30 секунд
                setInterval(fetchAllStatuses, 30000);
                
                // Поиск
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        currentSearch = e.target.value;
                        renderBoxes();
                    });
                }
                
                // Фильтры
                filterButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        filterButtons.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        currentFilter = btn.dataset.filter;
                        renderBoxes();
                    });
                });
                
                // Сортировка
                sortButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        sortButtons.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        currentSort = btn.dataset.sort;
                        renderBoxes();
                    });
                });
                
                // Кнопка обновления
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', fetchAllStatuses);
                }
                
                console.log('Приложение инициализировано успешно');
            }
            
            // Запуск приложения
            init();
            
            // Экспорт функции для использования в HTML
            window.copyToClipboard = copyToClipboard;
        });
    </script>
</body>
</html>